head

	title Blank

	link(rel='shortcut icon', href='/favicon.ico', type='image/x-icon')
	link(rel='icon', href='/favicon.ico', type='image/x-icon')


	link(rel="stylesheet", 
	href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700|Open+Sans:300,400,600,700")
	link(rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.0/normalize.min.css")
	link(rel='stylesheet' href='https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css' integrity='sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm' crossorigin='anonymous')
	link(rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/noty/3.1.4/noty.min.css')


body
	style(scoped).
		body{
			margin:0px;
			padding:0px;
		}

		#editor{
			font-size: 12pt;
			min-width: 100%;
			min-height: 100vh;
		}
		.list-group-item span{
			font-size:12px;
		}
		.list-group-item span.tiny, textarea.tiny{
			font-size:8px;
		}
		textarea.tiny{
			height:25px;
		}
		.clipboard{
			width:100%;
			height:50px;
		}
		.name{
			min-width:230px;
		}
		.search{
			max-height: 350px;
			overflow: scroll;
		}
		.search.active{
			position: fixed;
			z-index: 9999;
			top: 0;
			width: 250px;
			max-height: calc(100vh);
			background: white;
			overflow: scroll;
			right: 0;
		}
		.search-input{
			display: block;
			background: dimgrey;
		    border: 0px;
		    color: white;
		    font-size: 14px;
		}
		.search-input::placeholder{
			color:white;
		}
		.search.active .search-input{
			display: block;
		}
		.search .list-group-item{
		    padding: 10px;
			background: slategrey;
			color: white;
		    color
		    border-radius: 0px;
		    margin: 0px;
		    cursor: pointer;
		}
		.search .list-group-item, .search-input{
			border-top-left-radius: 0px!important;
		    border-top-right-radius: 0px!important;
		    border-bottom-left-radius: 0px!important;
		    border-bottom-right-radius: 0px!important;
		}
		.clipboard, .clipboard:active,.clipboard:focus{
			background: #333;
			color: white;
			min-height: 300px;
		}
	#app
		.row.no-gutters
			.col-12
				div#editor
		.row.no-gutters
			.col-12.col-lg-6.p-2
				h6 Clipboard
				textarea.form-control.clipboard(@keyup="saveClipboard",v-model="clipboard")
			.col-12.col-lg-6.p-2
				.search(ref="searchModal")
					input.form-control.search-input(v-model="filter",ref="searchInput",placeholder="Filter")
					ul.list-group
						li.list-group-item(v-for="item,key in filteredItems" v-bind:key="key",@click="select(item)")
							span(v-html="item.name")
							span.tiny.d-block(v-html="item.type")
			.col-12.col-lg-12.p-2
				.row.no-gutters
					.col.mr-1
						button.btn.btn-primary.form-control.border-0(v-on:click="save",v-bind:disabled="!canSave")='Save (cmd+shift+s)'
					.col.mr-1
						input.form-control.name(v-model="item.name",placeholder="Name")
					.col.mr-1
						input.form-control(v-model="item.type",placeholder="Type")
					//-
						.col
							input.form-control(v-model="item.path",placeholder="Path")
					.col.mr-1
						button.btn.btn-secondary.border-0.form-control(@click="newItem") New
			.col-12.p-2
				textarea.tiny.form-control(disabled, v-html="resourceUrl")
			.col-12.p-2
				textarea.tiny.form-control(disabled, v-html="'script(src=\"'+resourceUrl+'\")'")
		
	script(src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.10/lodash.min.js")
	script(src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js")
	script(async src="https://pro.fontawesome.com/releases/v5.0.8/js/all.js")
	script(src='https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js')
	script(src='https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js')
	script(src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.3.3/ace.js")
	script(src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.3.3/ext-language_tools.js")
	script(src="https://cdnjs.cloudflare.com/ajax/libs/js-beautify/1.7.5/beautify.min.js")
	script(src="https://cdnjs.cloudflare.com/ajax/libs/js-beautify/1.7.5/beautify-css.min.js")
	script(src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.0/moment.min.js")
	script(src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js")
	script(src="https://cdnjs.cloudflare.com/ajax/libs/noty/3.1.4/noty.min.js")
	script(src="/js/common.js")
	script.
		new Vue({
			el: "#app",
			data: function() {
				return{
					filter:'',
					items:[],
					clipboard:`This is a clipboard
		||`,
					item:{
						_id:null,
						type:'vueComponent',
						name:'',
						path:'',
						code:''
					}
				}
			},
			methods:{
				newItem(){
					var self = this;
					Object.keys(this.item).forEach(k=>self.item[k]='');
					this.item.type= 'vueComponent'
					this.editor.setValue(this.item.code);
				},
				loadClipBoard(){
					this.clipboard = window.localStorage.getItem('simback_clipboard')||'||';
				},
				saveClipboard(){
					window.localStorage.setItem('simback_clipboard', this.clipboard);
				},
				select(item){
					var self= this;
					if(this.item._id){
						return this.save().then(()=>{
							self.newItem();
							self.select(item);
						});
					}
					Object.assign(this.item, item);
					this.editor.setValue(this.item.code);
					this.closeSearchModal();
				},
				save(){
					return new Promise((resolve,reject)=>{
						var self= this;
						httpPost('/rpc/save-file',this.item).then(r=>{
							self.updateItems();

							new Noty({
							type:'info',
							timeout:2000,
							text: this.item.name+' saved', killer:true, layout:"bottomRight"
							}).show();
							resolve();
							console.info(r);
						}).catch(err=>{

							console.warn(err);
							new Noty({
							type:'warning',
							timeout:2000,
							text: this.item.name+' not saved', killer:true, layout:"bottomRight"
							}).show();
							reject();

						});
					})
				},
				updateItems(){
					var self= this;
					httpPost('/rpc/fetch/',{
						type:['vueComponent','javascript']
					}).then(data=>{
						self.items = data;
					}).catch(console.warn);
				},
				closeSearchModal(){
					$(this.$refs.searchModal).removeClass('active');
				},
				onEscapeCloseSearch(e){
					if (e.keyCode == 27) {
						this.closeSearchModal();	
					}
				},
				bindOnEscapeCloseSearch(){
					$(document).keyup(this.onEscapeCloseSearch.bind(this));
				}
			},
			destroyed(){
				$(document).off('keyup',this.onEscapeCloseSearch);
			},
			computed:{
				filteredItems(){
					return !!this.filter?this.items.filter(i=>i.name.indexOf(this.filter)!==-1) : this.items;
				},
				resourceUrl(){
					return `https://simback.herokuapp.com/resource/${this.item.type}/${this.item.name}?ext=js`
				},
				canSave(){
					return !!this.item.name && !!this.item.code && !!this.item.type
				}
			},
			mounted(){
				var self = this;
				self.bindOnEscapeCloseSearch();
				editor = self.editor = ace.edit("editor");
				editor.setTheme("ace/theme/monokai");
				editor.session.setMode('ace/mode/javascript');
				editor.session.setOptions({
					wrap: true,
					tabSize: 4,
					useSoftTabs: false
				});
				editor.setOptions({
					enableLiveAutocompletion: true,
					fontSize: "12pt",
					showPrintMargin: false
				});
				
				editor.commands.addCommand({
					name: 'open',
					bindKey: {
						win: 'Alt-Shift-O',
						mac: 'Command-Shift-O'
					},
					exec: function(editor) {
						$(self.$refs.searchModal).addClass('active');
						self.$refs.searchInput.focus();
						self.updateItems();
					},
					readOnly: false
				});
				editor.commands.addCommand({
					name: 'new',
					bindKey: {
						win: 'Alt-Shift-K',
						mac: 'Command-Shift-K'
					},
					exec: function(editor) {
						self.newItem();
					},
					readOnly: false
				});
				editor.commands.addCommand({
					name: 'save',
					bindKey: {
						win: 'Alt-Shift-S',
						mac: 'Command-Shift-S'
					},
					exec: function(editor) {
						if(self.canSave){
							self.save();
						}
					},
					readOnly: false
				});
				editor.commands.addCommand({
					name: 'beautify',
					bindKey: {
						win: 'Ctrl-B',
						mac: 'Command-B'
					},
					exec: function(editor) {
						beautifyAceEditor(editor)
					},
					readOnly: false
				});
				editor.on("change",data=>self.item.code=editor.getValue())
				self.updateItems();
				self.loadClipBoard();
			}
		});
